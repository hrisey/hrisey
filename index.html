<!DOCTYPE html>
<html>
<head>
	<title>Ferjuáætlun</title>
	<meta charset="UTF-8">
</head>
<body>

<h1>Hrísey - ferjuáætlun</h1>

<div id="content"></div>

<script type="text/javascript">
	const CLIENT_ID = '576102823095-jkndirid4ktj8anpr761plagj3h6n38n.apps.googleusercontent.com';
	const API_KEY = 'AIzaSyByEghYhZYQRCvewgMiV-gtz1VhESUZRaI';
	const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
	const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
	const CALENDAR_ID = '56gip1uek5lc3di2qqsrp3vi04@group.calendar.google.com';
	const months = [
		'janúar',
		'febrúar',
		'mars',
		'apríl',
		'maí',
		'júní',
		'júlí',
		'ágúst',
		'september',
		'október',
		'nóvember',
		'desember'
	];

	const days = [
		'Sunnudagur',
		'Mánudagur',
		'Þriðjudagur',
		'Miðvikudagur',
		'Fimmtudagur',
		'Föstudagur',
		'Laugardagur'
	];

	function handleClientLoad() {
		gapi.load('client:auth2', initClient);
	}

	function initClient() {
		gapi.client.init({
			apiKey: API_KEY,
			clientId: CLIENT_ID,
			discoveryDocs: DISCOVERY_DOCS,
			scope: SCOPES
		}).then(function () {
			const date = new Date();
			listUpcomingEvents(date);
		}, function (error) {
			appendPre(JSON.stringify(error, null, 2));
		});
	}

	function appendPre(message) {
		var content = document.getElementById('content');
		var p = document.createElement("p");
		var textContent = document.createTextNode(message);
		p.appendChild(textContent);
		content.appendChild(p);
	}

	function pad(num) {
		return ("0"+num).slice(-2)
	}

	function getTime(time)
	{
		time = new Date(time);
		return pad(time.getHours()) + ':' + pad(time.getMinutes());
	}

	function listUpcomingEvents(date) {
		const dateStart = new Date(date);
		dateStart.setHours(0,0);
		const dateEnd = new Date(date);
		dateEnd.setHours(23,59,59);

		const selectedDate = days[dateStart.getDay()]
			+ ', ' + dateStart.getDate()
			+ '. ' + months[dateStart.getMonth()]
			+ ' ' + dateStart.getFullYear();
		appendPre(selectedDate)

		gapi.client.calendar.events.list({
			calendarId: CALENDAR_ID,
			timeMin: dateStart.toISOString(),
			timeMax: dateEnd.toISOString(),
			showDeleted: false,
			singleEvents: true,
			orderBy: 'startTime'
		}).then(function(response) {
			const events = response.result.items;
			if (events.length > 0) {
				events.forEach(function(event) {
					var time1 = getTime(event.start.dateTime);
					var time2 = getTime(event.end.dateTime);
					var title = event.summary.replace(/\(([^)]+)\)/, "")
					appendPre(title + ' (Frá Hrísey: ' + time1 + '. Frá Árskógssandi ' + time2 + ')')
				});
			}
			else {
				appendPre('Engin gögn fundust. Reynið aftur síðar.');
			}
		});
	}

</script>

<script async defer src="https://apis.google.com/js/api.js"
	onload="this.onload=function(){};handleClientLoad()"
	onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
</body>
</html>
